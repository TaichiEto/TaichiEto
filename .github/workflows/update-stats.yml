name: Update GitHub Stats

on:
  schedule:
    # æ¯æ—¥åˆå‰9æ™‚ï¼ˆJSTï¼‰ã«å®Ÿè¡Œï¼ˆUTC 0æ™‚ï¼‰
    - cron: '0 0 * * *'
  workflow_dispatch: # æ‰‹å‹•å®Ÿè¡Œã‚‚å¯èƒ½

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write  # ãƒªãƒã‚¸ãƒˆãƒªã¸ã®æ›¸ãè¾¼ã¿æ¨©é™
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        
    - name: Download GitHub Stats Images
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        CUSTOM_API_BASE: https://github-readme-stats-nrqr0uivp-taichietos-projects.vercel.app
      run: |
        # ãƒ‡ãƒãƒƒã‚°: APIã®å¿œç­”ã‚’ç¢ºèª
        echo "APIå¿œç­”ã‚’ãƒã‚§ãƒƒã‚¯ä¸­..."
        
        # çµ±è¨ˆç”»åƒã‚’å–å¾—
        curl -v -H "Authorization: token $GITHUB_TOKEN" \
          "$CUSTOM_API_BASE/api?username=TaichiEto&show_icons=true&theme=dark&include_all_commits=true&count_private=true" \
          -o stats.svg
          
        # è¨€èªçµ±è¨ˆç”»åƒã‚’å–å¾—  
        curl -v -H "Authorization: token $GITHUB_TOKEN" \
          "$CUSTOM_API_BASE/api/top-langs/?username=TaichiEto&layout=compact&theme=dark&include_private=true" \
          -o top-langs.svg
        
        # ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºã¨ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’ç¢ºèª
        echo "stats.svg ã‚µã‚¤ã‚º: $(wc -c < stats.svg) bytes"
        echo "top-langs.svg ã‚µã‚¤ã‚º: $(wc -c < top-langs.svg) bytes"
        
        # SVGãƒ•ã‚¡ã‚¤ãƒ«ã®å…ˆé ­ã‚’ç¢ºèª
        echo "=== stats.svg ã®å…ˆé ­ ==="
        head -n 5 stats.svg
        echo "=== top-langs.svg ã®å…ˆé ­ ==="
        head -n 5 top-langs.svg
          
        # ãƒ•ã‚¡ã‚¤ãƒ«ãŒæ­£å¸¸ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸã‹ç¢ºèª
        if [ ! -f stats.svg ] || [ ! -f top-langs.svg ]; then
          echo "ç”»åƒã®ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ"
          exit 1
        fi
        
        # SVGãƒ•ã‚¡ã‚¤ãƒ«ã¨ã—ã¦æœ‰åŠ¹ã‹ãƒã‚§ãƒƒã‚¯
        if ! grep -q "<svg" stats.svg; then
          echo "stats.svg ã¯æœ‰åŠ¹ãªSVGãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“"
          cat stats.svg
          exit 1
        fi
        
        if ! grep -q "<svg" top-langs.svg; then
          echo "top-langs.svg ã¯æœ‰åŠ¹ãªSVGãƒ•ã‚¡ã‚¤ãƒ«ã§ã¯ã‚ã‚Šã¾ã›ã‚“" 
          cat top-langs.svg
          exit 1
        fi
        
        # ç”»åƒã‚’ assets ãƒ•ã‚©ãƒ«ãƒ€ã«ç§»å‹•
        mkdir -p assets
        mv stats.svg assets/
        mv top-langs.svg assets/
    
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # å¤‰æ›´ãŒã‚ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
        git add assets/
        if git diff --staged --quiet; then
          echo "å¤‰æ›´ãŒã‚ã‚Šã¾ã›ã‚“"
          exit 0
        fi
        
        git commit -m "ğŸ“Š Update GitHub stats [automated]"
        git push
