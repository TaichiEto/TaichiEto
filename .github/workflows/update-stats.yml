name: Test New Vercel URL

on:
  workflow_dispatch: # 手動実行のみ

jobs:
  test-new-url:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
        
    - name: Test New Vercel URL
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NEW_API_BASE: https://github-readme-stats-51peqpn0u-taichietos-projects.vercel.app
        OLD_API_BASE: https://github-readme-stats-nrqr0uivp-taichietos-projects.vercel.app
      run: |
        echo "=== 新しいURL ($NEW_API_BASE) をテスト ==="
        
        # 新しいURLで認証なしテスト
        echo "1. 認証なしでテスト..."
        curl -v "$NEW_API_BASE/api?username=TaichiEto&show_icons=true&theme=dark" \
          -o test-new-noauth.svg 2>&1 | head -n 20
        
        echo "新しいURL(認証なし) レスポンス先頭:"
        head -n 3 test-new-noauth.svg
        
        # 新しいURLで認証ありテスト
        echo -e "\n2. 認証ありでテスト..."
        curl -v -H "Authorization: token $GITHUB_TOKEN" \
          "$NEW_API_BASE/api?username=TaichiEto&show_icons=true&theme=dark&count_private=true" \
          -o test-new-auth.svg 2>&1 | head -n 20
        
        echo "新しいURL(認証あり) レスポンス先頭:"
        head -n 3 test-new-auth.svg
        
        # 比較のため旧URLもテスト
        echo -e "\n3. 旧URLで認証ありテスト（比較用）..."
        curl -v -H "Authorization: token $GITHUB_TOKEN" \
          "$OLD_API_BASE/api?username=TaichiEto&show_icons=true&theme=dark&count_private=true" \
          -o test-old-auth.svg 2>&1 | head -n 20
        
        echo "旧URL(認証あり) レスポンス先頭:"
        head -n 3 test-old-auth.svg
        
        # ファイルサイズ比較
        echo -e "\n=== ファイルサイズ比較 ==="
        echo "新URL(認証なし): $(wc -c < test-new-noauth.svg) bytes"
        echo "新URL(認証あり): $(wc -c < test-new-auth.svg) bytes"
        echo "旧URL(認証あり): $(wc -c < test-old-auth.svg) bytes"
        
        # SVGファイルかチェック
        echo -e "\n=== SVG判定 ==="
        for file in test-new-noauth.svg test-new-auth.svg test-old-auth.svg; do
          if grep -q "<svg" "$file"; then
            echo "✅ $file は有効なSVGファイル"
          else
            echo "❌ $file は無効（認証エラーまたはHTML）"
          fi
        done
