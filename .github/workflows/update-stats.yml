name: Update GitHub Stats with Private Repos

on:
  schedule:
    - cron: '0 0 * * *'
  workflow_dispatch:

jobs:
  update-stats:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
        
    - name: Download GitHub Stats Images
      env:
        # Personal Access Token を使用
        GITHUB_PAT: ${{ secrets.GITHUB_PAT }}
        CUSTOM_API_BASE: https://github-readme-stats-nrqr0uivp-taichietos-projects.vercel.app
      run: |
        echo "プライベートリポジトリを含むGitHub統計を取得中..."
        
        # PATを使ってカスタムAPIにアクセス
        curl -H "Authorization: token $GITHUB_PAT" \
          "$CUSTOM_API_BASE/api?username=TaichiEto&show_icons=true&theme=dark&include_all_commits=true&count_private=true" \
          -o stats.svg
          
        curl -H "Authorization: token $GITHUB_PAT" \
          "$CUSTOM_API_BASE/api/top-langs/?username=TaichiEto&layout=compact&theme=dark&include_private=true&langs_count=8" \
          -o top-langs.svg
        
        # デバッグ: ファイル内容確認
        echo "stats.svg サイズ: $(wc -c < stats.svg) bytes"
        echo "top-langs.svg サイズ: $(wc -c < top-langs.svg) bytes"
        
        # SVGかHTMLかチェック
        if grep -q "<svg" stats.svg; then
          echo "✅ stats.svg は有効なSVGファイルです"
        else
          echo "❌ stats.svg は認証エラーです:"
          head -n 3 stats.svg
          exit 1
        fi
        
        if grep -q "<svg" top-langs.svg; then
          echo "✅ top-langs.svg は有効なSVGファイルです"
        else
          echo "❌ top-langs.svg は認証エラーです:"
          head -n 3 top-langs.svg
          exit 1
        fi
        
        # 画像を assets フォルダに移動
        mkdir -p assets
        mv stats.svg assets/
        mv top-langs.svg assets/
    
    - name: Commit and push if changed
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        git add assets/
        if git diff --staged --quiet; then
          echo "変更がありません"
          exit 0
        fi
        
        git commit -m "📊 Update GitHub stats with private repos [automated]"
        git push
